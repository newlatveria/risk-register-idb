<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add/Edit Risk</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; } /* Increased margin for editors */
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        
        /* Input styling */
        .form-group input:not([type="number"]), .form-group select {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        .form-group input[type="number"] {
            width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; text-align: center;
        }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; font-weight: bold; }

        /* QUILL EDITOR STYLING */
        .editor-container { height: 150px; background-color: white; }
        .ql-toolbar { background-color: #f8f9fa; border-radius: 4px 4px 0 0; }
        .ql-container { border-radius: 0 0 4px 4px; font-size: 16px; }

        /* Layout for rating sections */
        .rating-section { display: flex; gap: 20px; margin-top: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; }
        .rating-group { flex: 1; min-width: 0; }
        .rating-group h3 { margin-top: 0; margin-bottom: 10px; color: #007bff; font-size: 1.1em; }
        .rating-fields { display: flex; justify-content: space-between; align-items: flex-end; gap: 10px; }
        .rating-fields > div { flex: 1; }

        .action-buttons { margin-top: 30px; display: flex; justify-content: space-between; }
        .action-buttons button { padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; }
        #saveButton { background-color: #28a745; color: white; }
        #saveButton:hover { background-color: #1e7e34; }
        #cancelButton { background-color: #6c757d; color: white; }
        #cancelButton:hover { background-color: #5a6268; }

        .additional-details { margin-top: 30px; padding: 20px; border: 1px dashed #007bff; border-radius: 4px; background-color: #f0f8ff; }
        .additional-details h2 { color: #007bff; margin-top: 0; border-bottom: 1px solid #007bff; padding-bottom: 5px; }
        .additional-fields-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .source-details { border-left: 5px solid #8c72a8; padding-left: 15px; background-color: #f3f0f7; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="formTitle">Add New Risk</h1>
        <form id="riskForm">
            
            <div class="form-group">
                <label for="riskNumber">Risk Number</label>
                <input type="text" id="riskNumber" readonly>
            </div>
            <div class="form-group">
                <label for="dateRaised">Date Raised <span style="color:red;">*</span></label>
                <input type="date" id="dateRaised" required>
            </div>
            <div class="form-group">
                <label for="riskItem">Risk Item (Concise Summary) <span style="color:red;">*</span></label>
                <input type="text" id="riskItem" required>
            </div>

            <div class="form-group">
                <label>Risk Issue (Detailed Description) <span style="color:red;">*</span></label>
                <div id="editor-riskIssue" class="editor-container"></div>
            </div>

            <div class="form-group">
                <label>Impact Statement</label>
                <div id="editor-impactStatement" class="editor-container"></div>
            </div>

            <div class="form-group">
                <label for="relatedRisks">Linked Risks (Dependencies)</label>
                <input type="text" id="relatedRisks" name="relatedRisks" placeholder="e.g., 1002, 1005 (Comma separated Risk Numbers)">
                <small style="color:#666;">Enter the Risk Numbers of any risks that are caused by or related to this one.</small>
            </div>
            
            <div class="form-group">
                <label for="riskOwner">Risk Owner <span style="color:red;">*</span></label>
                <input type="text" id="riskOwner" list="ownerList" required>
                <datalist id="ownerList"></datalist>
            </div>
            
            <div class="form-group">
                <label for="riskStatus">Risk Status <span style="color:red;">*</span></label>
                <select id="riskStatus" required>
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reviewDate">Next Review Date</label>
                <input type="date" id="reviewDate">
            </div>

            <div class="rating-section">
                <div class="rating-group">
                    <h3>Initial Risk</h3>
                    <div class="rating-fields">
                        <div class="form-group"><label>Prob.</label><input type="number" id="probabilityInitial" min="1" max="5" oninput="calcMetrics()"></div>
                        <div class="form-group"><label>Impact</label><input type="number" id="impactInitial" min="1" max="5" oninput="calcMetrics()"></div>
                        <div class="form-group"><label>Score</label><input type="text" id="riskScoreInitial" readonly></div>
                        <div class="form-group"><label>Rating</label><input type="text" id="riskRatingInitial" readonly></div>
                    </div>
                </div>
                <div class="rating-group">
                    <h3>Residual Risk</h3>
                    <div class="rating-fields">
                        <div class="form-group"><label>Prob.</label><input type="number" id="probabilityResidual" min="1" max="5" oninput="calcMetrics()"></div>
                        <div class="form-group"><label>Impact</label><input type="number" id="impactResidual" min="1" max="5" oninput="calcMetrics()"></div>
                        <div class="form-group"><label>Score</label><input type="text" id="riskScoreResidual" readonly></div>
                        <div class="form-group"><label>Rating</label><input type="text" id="riskRatingResidual" readonly></div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Controls / Mitigations</label>
                <div id="editor-controlsMitigations" class="editor-container"></div>
            </div>
            
            <div class="form-group">
                <label>Actions Text / Notes</label>
                <div id="editor-actionsText" class="editor-container"></div>
            </div>

            <div class="form-group">
                <label>Notes / History</label>
                <div id="editor-notesHistory" class="editor-container"></div>
            </div>

            <div class="additional-details">
                <h2>Additional Details</h2>
                <div class="additional-fields-grid">
                    <div class="form-group"><label>Raised By</label><input type="text" id="raisedBy"></div>
                    <div class="form-group"><label>Impacted Area</label><input type="text" id="impactedArea"></div>
                    <div class="form-group"><label>Risk Category</label><input type="text" id="riskCategory"></div>
                    <div class="form-group"><label>Related Laws/Regs</label><input type="text" id="relatedLaws"></div>
                    <div class="form-group"><label>Non-Compliance Impact</label><input type="text" id="nonComplianceImpact"></div>
                    <div class="form-group"><label>Outcome Definition</label><input type="text" id="outcomeDefinition"></div>
                </div>
                <div class="source-details" style="margin-top: 20px;">
                    <h3>Source Details</h3>
                    <div class="additional-fields-grid">
                        <div class="form-group"><label>Source Dept</label><input type="text" id="sourceDepartment"></div>
                        <div class="form-group"><label>Source Last Review</label><input type="date" id="sourceLastReviewDate"></div>
                        <div class="form-group"><label>Source Due Date</label><input type="date" id="sourceDueDate"></div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button type="button" id="cancelButton">Cancel / Back</button>
                <button type="submit" id="saveButton">Save Risk</button>
            </div>
        </form>
    </div>

    <script>
        // --- QUILL INIT ---
        // Initialize editors and store references in an object
        const quillEditors = {};
        const editorIds = ['riskIssue', 'impactStatement', 'controlsMitigations', 'actionsText', 'notesHistory'];
        
        editorIds.forEach(id => {
            quillEditors[id] = new Quill(`#editor-${id}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'color': [] }, { 'background': [] }],
                        ['clean']
                    ]
                }
            });
        });

        // --- DB WRAPPER (Simplified for brevity, same logic as index.html) ---
        const DB_NAME = 'RiskRegisterDB';
        const STORE_NAME = 'risks';
        function initDB() { return new Promise((res, rej) => { const r = indexedDB.open(DB_NAME, 1); r.onsuccess = e => res(e.target.result); r.onerror = e => rej(e); }); }
        async function getAllRisksDB() { const db = await initDB(); return new Promise((res) => { db.transaction([STORE_NAME]).objectStore(STORE_NAME).getAll().onsuccess = e => res(e.target.result); }); }
        async function getRiskDB(id) { const db = await initDB(); return new Promise((res) => { db.transaction([STORE_NAME]).objectStore(STORE_NAME).get(id).onsuccess = e => res(e.target.result); }); }
        async function putRiskDB(risk) { const db = await initDB(); return new Promise((res) => { db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).put(risk).onsuccess = () => res(); }); }

        // --- UTILS ---
        function getFormattedDate(str) { 
            if(!str) return ''; 
            let d = new Date(str); 
            if(isNaN(d.getTime())) { const p=str.split('/'); if(p.length===3) d=new Date(p[2],p[1]-1,p[0]); }
            if(isNaN(d.getTime())) return '';
            return d.toISOString().split('T')[0]; 
        }
        function safeInt(v) { return parseInt(v) || ''; }
        function getRating(s) { if(!s)return ''; if(s<=5)return 'Low'; if(s<=10)return 'Medium'; if(s<=15)return 'High'; return 'Critical'; }
        
        function calcMetrics() {
            const pi = safeInt(document.getElementById('probabilityInitial').value);
            const ii = safeInt(document.getElementById('impactInitial').value);
            document.getElementById('riskScoreInitial').value = (pi&&ii)? pi*ii : '';
            document.getElementById('riskRatingInitial').value = getRating((pi&&ii)? pi*ii : '');

            const pr = safeInt(document.getElementById('probabilityResidual').value);
            const ir = safeInt(document.getElementById('impactResidual').value);
            document.getElementById('riskScoreResidual').value = (pr&&ir)? pr*ir : '';
            document.getElementById('riskRatingResidual').value = getRating((pr&&ir)? pr*ir : '');
        }

        // --- LOAD/SAVE ---
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id'); // This is the riskNumber string

        async function loadPage() {
            const allRisks = await getAllRisksDB();
            
            // Populate Owner Datalist
            const owners = [...new Set(allRisks.map(r => r.riskOwner).filter(o => o))].sort();
            document.getElementById('ownerList').innerHTML = owners.map(o => `<option value="${o}">`).join('');

            if (editId) {
                document.getElementById('formTitle').innerText = `Edit Risk #${editId}`;
                const risk = await getRiskDB(editId);
                if(risk) {
                    document.getElementById('riskNumber').value = risk.riskNumber;
                    document.getElementById('dateRaised').value = getFormattedDate(risk.dateRaised);
                    document.getElementById('riskItem').value = risk.riskItem || '';
                    document.getElementById('raisedBy').value = risk.raisedBy || '';
                    document.getElementById('impactedArea').value = risk.impactedArea || '';
                    document.getElementById('riskCategory').value = risk.riskCategory || '';
                    document.getElementById('relatedLaws').value = risk.relatedLaws || '';
                    document.getElementById('nonComplianceImpact').value = risk.nonComplianceImpact || '';
                    document.getElementById('outcomeDefinition').value = risk.outcomeDefinition || '';
                    document.getElementById('riskOwner').value = risk.riskOwner || '';
                    document.getElementById('riskStatus').value = risk.riskStatus || 'Open';
                    document.getElementById('reviewDate').value = getFormattedDate(risk.reviewDate);
                    
                    // Load Rich Text Content into Quill
                    quillEditors['riskIssue'].root.innerHTML = risk.riskIssue || '';
                    quillEditors['impactStatement'].root.innerHTML = risk.impactStatement || '';
                    quillEditors['controlsMitigations'].root.innerHTML = risk.controlsMitigations || '';
                    quillEditors['actionsText'].root.innerHTML = risk.actionsText || '';
                    quillEditors['notesHistory'].root.innerHTML = risk.notesHistory || '';

                    document.getElementById('probabilityInitial').value = risk.probabilityInitial;
                    document.getElementById('impactInitial').value = risk.impactInitial;
                    document.getElementById('probabilityResidual').value = risk.probabilityResidual;
                    document.getElementById('impactResidual').value = risk.impactResidual;
                    
                    document.getElementById('sourceDepartment').value = risk.sourceDepartment || '';
                    document.getElementById('sourceLastReviewDate').value = getFormattedDate(risk.sourceLastReviewDate);
                    document.getElementById('sourceDueDate').value = getFormattedDate(risk.sourceDueDate);
                }
            } else {
                // Add Mode
                const maxNum = allRisks.reduce((max, r) => Math.max(max, parseInt(r.riskNumber)||0), 0);
                document.getElementById('riskNumber').value = maxNum + 1;
                document.getElementById('dateRaised').value = new Date().toISOString().split('T')[0];
            }
            calcMetrics();
        }

        document.getElementById('riskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const risk = {
                riskNumber: String(document.getElementById('riskNumber').value),
                dateRaised: document.getElementById('dateRaised').value,
                riskItem: document.getElementById('riskItem').value,
                
                // Retrieve HTML from Quill Editors
                riskIssue: quillEditors['riskIssue'].root.innerHTML,
                impactStatement: quillEditors['impactStatement'].root.innerHTML,
                controlsMitigations: quillEditors['controlsMitigations'].root.innerHTML,
                actionsText: quillEditors['actionsText'].root.innerHTML,
                notesHistory: quillEditors['notesHistory'].root.innerHTML,

                riskOwner: document.getElementById('riskOwner').value,
                riskStatus: document.getElementById('riskStatus').value,
                reviewDate: document.getElementById('reviewDate').value,
                
                raisedBy: document.getElementById('raisedBy').value,
                impactedArea: document.getElementById('impactedArea').value,
                riskCategory: document.getElementById('riskCategory').value,
                relatedLaws: document.getElementById('relatedLaws').value,
                nonComplianceImpact: document.getElementById('nonComplianceImpact').value,
                outcomeDefinition: document.getElementById('outcomeDefinition').value,

                probabilityInitial: safeInt(document.getElementById('probabilityInitial').value),
                impactInitial: safeInt(document.getElementById('impactInitial').value),
                riskScoreInitial: document.getElementById('riskScoreInitial').value,
                riskRatingInitial: document.getElementById('riskRatingInitial').value,

                probabilityResidual: safeInt(document.getElementById('probabilityResidual').value),
                impactResidual: safeInt(document.getElementById('impactResidual').value),
                riskScoreResidual: document.getElementById('riskScoreResidual').value,
                riskRatingResidual: document.getElementById('riskRatingResidual').value,

                sourceDepartment: document.getElementById('sourceDepartment').value,
                sourceLastReviewDate: document.getElementById('sourceLastReviewDate').value,
                sourceDueDate: document.getElementById('sourceDueDate').value,
            };

            await putRiskDB(risk);
            alert('Risk saved successfully!');
            window.location.href = 'index.html';
        });

        document.getElementById('cancelButton').onclick = () => window.location.href = 'index.html';

        loadPage();
    </script>
</body>
</html>