<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Register - Enhanced Version</title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #d9534f;
            --info-color: #17a2b8;
            --light-bg: #f4f4f4;
            --white: #fff;
            --border-color: #ddd;
            --text-color: #333;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 20px;
            background-color: var(--light-bg);
            color: var(--text-color);
        }

        h1, h2 {
            color: var(--primary-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 250px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast-success { background-color: var(--success-color); }
        .toast-error { background-color: var(--danger-color); }
        .toast-warning { background-color: var(--warning-color); color: var(--text-color); }
        .toast-info { background-color: var(--info-color); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        .toast.removing {
            animation: slideOut 0.3s ease-out;
        }

        /* === GLOBAL LOADER === */
        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loader-content {
            background: white;
            padding: 30px 40px;
            border-radius: 8px;
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === ACTION BAR === */
        .action-bar {
            display: flex;
            gap: 10px;
            padding: 15px 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-bar-left {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-bar-right {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* === SEARCH BOX === */
        .search-box {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            min-width: 300px;
        }

        .search-box input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 14px;
        }

        .search-box .clear-search {
            cursor: pointer;
            color: #999;
            display: none;
        }

        .search-box .clear-search.visible {
            display: block;
        }

        /* === FILTER CONTROLS === */
        .filter-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .filter-actions > div {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-actions label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .filter-badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .clear-filters-btn {
            background: var(--danger-color) !important;
            padding: 6px 12px !important;
            font-size: 14px !important;
        }

        /* === BUTTONS & INPUTS === */
        button, select {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        button:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        select {
            background-color: #f8f9fa;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            cursor: pointer;
        }

        select:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        input[type="file"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            background-color: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }

        input.inline-edit, select.inline-edit {
            padding: 4px 8px;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            border: 2px solid var(--primary-color);
            background-color: var(--white);
            font-family: inherit;
        }

        /* Button color variants */
        .btn-success { background-color: var(--success-color) !important; }
        .btn-success:hover { background-color: #1e7e34 !important; }
        .btn-danger { background-color: var(--danger-color) !important; }
        .btn-danger:hover { background-color: #c9302c !important; }
        .btn-warning { background-color: var(--warning-color) !important; color: var(--text-color) !important; }
        .btn-warning:hover { background-color: #e0a800 !important; }
        .btn-info { background-color: var(--info-color) !important; }
        .btn-info:hover { background-color: #138496 !important; }

        /* === STATISTICS BAR === */
        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-bottom: 20px;
            color: white;
            flex-wrap: wrap;
        }

        .stat-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        /* === PAGINATION === */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 20px;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .pagination-controls button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .pagination-controls .page-number {
            padding: 8px 12px;
            background: none;
            color: var(--text-color);
        }

        .pagination-controls .page-number.active {
            background: var(--primary-color);
            color: white;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rows-per-page select {
            padding: 6px 10px;
            font-size: 14px;
        }

        /* === TABLE STYLES === */
        .table-scroll-container {
            max-height: 600px;
            overflow: auto;
            margin-top: 20px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        table thead th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            user-select: none;
        }

        table tbody td {
            padding: 0;
            border: 1px solid var(--border-color);
            vertical-align: top;
            height: 40px;
        }

        table tbody td > div {
            padding: 10px;
            height: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            white-space: normal;
        }

        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tbody tr:hover {
            background-color: #e9ecef;
        }

        .edit-btn {
            background-color: var(--warning-color);
            color: var(--text-color);
            margin-right: 5px;
            padding: 6px 12px;
            font-size: 0.9em;
        }

        .edit-btn:hover {
            background-color: #e0a800;
        }

        /* Risk Rating Classes */
        .risk-rating-low {
            background-color: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }

        .risk-rating-medium {
            background-color: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }

        .risk-rating-high {
            background-color: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }

        .risk-rating-critical {
            background-color: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }

        /* Sticky Columns */
        #riskTable th:first-child,
        #riskTable td:first-child,
        #riskTable th:last-child,
        #riskTable td:last-child {
            position: sticky;
            z-index: 11;
            background-color: inherit;
        }

        #riskTable th:first-child,
        #riskTable td:first-child {
            left: 0;
        }

        #riskTable th:last-child,
        #riskTable td:last-child {
            right: 0;
        }

        #riskTable th:first-child,
        #riskTable th:last-child {
            background-color: var(--primary-color);
            z-index: 12;
        }

        #riskTable tbody tr:nth-child(even) td:first-child,
        #riskTable tbody tr:nth-child(even) td:last-child {
            background-color: #f9f9f9;
        }

        #riskTable tbody tr:nth-child(odd) td:first-child,
        #riskTable tbody tr:nth-child(odd) td:last-child {
            background-color: var(--white);
        }

        /* Review Date Color Coding */
        .due-soon {
            background-color: #ffeb3b;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .due-next-week {
            background-color: #ffc107;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .overdue {
            background-color: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* === DATA MANAGEMENT === */
        .data-management-section {
            padding: 20px;
            margin-top: 20px;
            border-top: 2px solid var(--primary-color);
            background-color: #e9f5ff;
            border-radius: 8px;
        }

        .data-management-section h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .file-info {
            font-weight: 600;
            color: #555;
            margin-bottom: 15px;
            padding: 10px 15px;
            background-color: var(--white);
            border-left: 4px solid var(--success-color);
            border-radius: 4px;
        }

        .file-controls-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .file-controls-group > div {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* === KEYBOARD SHORTCUTS HINT === */
        .shortcuts-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }

        .shortcuts-hint.visible {
            display: block;
        }

        .shortcuts-hint kbd {
            background: #555;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        /* === UNDO/REDO BUTTONS === */
        .history-controls {
            display: flex;
            gap: 5px;
        }

        .history-controls button {
            padding: 8px 12px;
            font-size: 14px;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .action-bar-right {
                margin-left: 0;
            }

            .search-box {
                min-width: 100%;
            }

            .stats-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Risk Register <span style="font-size: 0.5em; color: #666;">Enhanced Edition</span></h1>

        <!-- Statistics Bar -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total Risks</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statCritical">0</div>
                <div class="stat-label">Critical</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statHigh">0</div>
                <div class="stat-label">High</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statOverdue">0</div>
                <div class="stat-label">Overdue</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statOpen">0</div>
                <div class="stat-label">Open</div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <div class="action-bar-left">
                <button id="addNewRiskButton" class="btn-success" aria-label="Add new risk">
                    ‚ûï Add New Risk
                </button>
                <button onclick="window.location.href='all_risks.html'" class="btn-info">
                    üìÑ Full Report
                </button>
                <button onclick="window.location.href='risk_map.html'" style="background-color: #6610f2;">
                    üï∏Ô∏è Risk Map
                </button>
            </div>
            <div class="action-bar-right">
                <div class="history-controls">
                    <button id="undoButton" title="Undo last change (Ctrl+Z)" disabled>
                        ‚Ü∂ Undo
                    </button>
                    <button id="redoButton" title="Redo (Ctrl+Shift+Z)" disabled>
                        ‚Ü∑ Redo
                    </button>
                </div>
                <div class="search-box">
                    <span>üîç</span>
                    <input type="text" id="globalSearch" placeholder="Search all fields..." 
                           aria-label="Search risks">
                    <span class="clear-search" id="clearSearch" title="Clear search">‚úï</span>
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-actions">
            <div>
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" aria-label="Filter by status">
                    <option value="">All</option>
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Closed">Closed</option>
                    <option value="On Hold">On Hold</option>
                </select>
            </div>
            <div>
                <label for="ratingFilter">Risk Rating:</label>
                <select id="ratingFilter" aria-label="Filter by rating">
                    <option value="">All Ratings</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div>
                <label for="ownerFilter">Risk Owner:</label>
                <select id="ownerFilter" aria-label="Filter by owner">
                    <option value="">All Owners</option>
                </select>
            </div>
            <div>
                <label for="reviewDateFilter">Review Date:</label>
                <select id="reviewDateFilter" aria-label="Filter by review date">
                    <option value="">Any Time</option>
                    <option value="Overdue">Overdue</option>
                    <option value="DueNextWeek">Due in 0-7 Days</option>
                    <option value="DueSoon">Due in 7-28 Days</option>
                </select>
            </div>
            <div id="activeFiltersContainer" style="display: none;">
                <span class="filter-badge" id="filterBadge">0</span>
                <button class="clear-filters-btn" id="clearFiltersBtn">Clear All Filters</button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-scroll-container">
            <table id="riskTable" role="grid" aria-label="Risk Register">
                <thead>
                    <tr role="row">
                        <th role="columnheader">Risk Number</th>
                        <th role="columnheader">Risk Item</th>
                        <th role="columnheader">Risk Owner</th>
                        <th role="columnheader">Rating (Residual)</th>
                        <th role="columnheader">Risk Status</th>
                        <th role="columnheader">Review Date</th>
                        <th role="columnheader">Linked Risks</th>
                        <th role="columnheader">Age (Days)</th>
                        <th role="columnheader">Date Raised</th>
                        <th role="columnheader">Raised By</th>
                        <th role="columnheader">Impact Statement</th>
                        <th role="columnheader">Controls/Mitigations</th>
                        <th role="columnheader">Prob (Initial)</th>
                        <th role="columnheader">Impact (Initial)</th>
                        <th role="columnheader">Score (Initial)</th>
                        <th role="columnheader">Rating (Initial)</th>
                        <th role="columnheader">Prob (Residual)</th>
                        <th role="columnheader">Impact (Residual)</th>
                        <th role="columnheader">Score (Residual)</th>
                        <th role="columnheader">Actions Text</th>
                        <th role="columnheader">Notes / History</th>
                        <th role="columnheader">Impacted Area</th>
                        <th role="columnheader">Risk Category</th>
                        <th role="columnheader">Related Laws/Regs</th>
                        <th role="columnheader">Non-Compliance Impact</th>
                        <th role="columnheader">Outcome Definition</th>
                        <th role="columnheader" style="background-color: #8c72a8;">Source Department</th>
                        <th role="columnheader" style="background-color: #8c72a8;">Source Last Review</th>
                        <th role="columnheader" style="background-color: #8c72a8;">Source Due Date</th>
                        <th role="columnheader">Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
            <div class="rows-per-page">
                <label for="rowsPerPage">Rows per page:</label>
                <select id="rowsPerPage">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="200">200</option>
                    <option value="all">All</option>
                </select>
            </div>
            <div class="pagination-info" id="paginationInfo">
                Showing 0-0 of 0 risks
            </div>
            <div class="pagination-controls" id="paginationControls">
            </div>
        </div>

        <!-- Data Management -->
        <div class="data-management-section">
            <h2>Data Import / Export</h2>
            
            <p id="lastFileDisplay" class="file-info">Last Imported Source: None</p>
            <p><strong>Warning:</strong> Loading a file will replace all existing data in the register.</p>
            
            <div class="file-controls-group">
                <div class="load-controls">
                    <input type="file" id="fileInput" accept=".json, .csv" 
                           aria-label="Select file to import">
                    <button id="loadDataButton">Load Data (File)</button>
                    <button id="loadDefaultFileButton" class="btn-warning">Load Default</button>
                </div>
            </div>
            
            <div class="file-controls-group">
                <div class="save-controls">
                    <button id="saveJsonButton">üíæ Save as JSON</button>
                    <button id="saveCsvButton" class="btn-warning">üìä Save as CSV</button>
                    <button id="manageDataButton" class="btn-danger">‚öôÔ∏è Manage Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Keyboard Shortcuts Hint -->
    <div class="shortcuts-hint" id="shortcutsHint">
        <div><kbd>Ctrl+Z</kbd> Undo | <kbd>Ctrl+Shift+Z</kbd> Redo | <kbd>Ctrl+F</kbd> Search | <kbd>?</kbd> Toggle hints</div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const CONFIG = {
            DB_NAME: 'RiskRegisterDB',
            DB_VERSION: 1,
            STORE_NAME: 'risks',
            DEFAULT_FILE_PATH: 'data/default_risks.json',
            ROWS_PER_PAGE: 100,
            DEBOUNCE_MS: 300,
            TOAST_DURATION: 3000,
            MAX_HISTORY: 50,
            RISK_SCORE_THRESHOLDS: {
                LOW: 5,
                MEDIUM: 10,
                HIGH: 15
            },
            DATE_FILTERS: {
                DUE_NEXT_WEEK: 7,
                DUE_SOON: 28
            }
        };

        const RISK_STATUSES = ["Open", "In Progress", "Closed", "On Hold"];

        // =============================================
        // STATE MANAGEMENT
        // =============================================
        class RiskRegisterState {
            constructor() {
                this.risks = [];
                this.filteredRisks = [];
                this.displayedRisks = [];
                this.filters = {
                    status: '',
                    rating: '',
                    owner: '',
                    reviewDate: '',
                    search: ''
                };
                this.pagination = {
                    currentPage: 1,
                    rowsPerPage: CONFIG.ROWS_PER_PAGE
                };
                this.history = [];
                this.historyIndex = -1;
                this.riskOwners = [];
            }

            setRisks(risks) {
                this.risks = risks;
                this.updateRiskOwnersList();
                this.applyFilters();
            }

            setFilter(key, value) {
                this.filters[key] = value;
                if (key !== 'search') {
                    localStorage.setItem(`filter_${key}`, value);
                }
                this.pagination.currentPage = 1;
                this.applyFilters();
            }

            clearAllFilters() {
                this.filters = {
                    status: '',
                    rating: '',
                    owner: '',
                    reviewDate: '',
                    search: ''
                };
                Object.keys(this.filters).forEach(key => {
                    if (key !== 'search') {
                        localStorage.removeItem(`filter_${key}`);
                    }
                });
                this.pagination.currentPage = 1;
                this.applyFilters();
            }

            applyFilters() {
                let filtered = [...this.risks];

                // Apply search
                if (this.filters.search) {
                    const searchTerm = this.filters.search.toLowerCase();
                    filtered = filtered.filter(risk => {
                        return Object.values(risk).some(value =>
                            String(value).toLowerCase().includes(searchTerm)
                        );
                    });
                }

                // Apply other filters
                if (this.filters.status) {
                    filtered = filtered.filter(r => r.riskStatus === this.filters.status);
                }

                if (this.filters.rating) {
                    filtered = filtered.filter(r => r.riskRatingResidual === this.filters.rating);
                }

                if (this.filters.owner) {
                    filtered = filtered.filter(r => r.riskOwner === this.filters.owner);
                }

                if (this.filters.reviewDate) {
                    filtered = filtered.filter(r => {
                        const metrics = calculateDateMetrics(r.dateRaised, r.reviewDate);
                        switch (this.filters.reviewDate) {
                            case 'Overdue':
                                return metrics.reviewDaysDiff < 0;
                            case 'DueSoon':
                                return metrics.reviewDaysDiff > 7 && metrics.reviewDaysDiff <= 28;
                            case 'DueNextWeek':
                                return metrics.reviewDaysDiff >= 0 && metrics.reviewDaysDiff <= 7;
                            default:
                                return true;
                        }
                    });
                }

                this.filteredRisks = filtered;
                this.updatePagination();
            }

            updatePagination() {
                const { currentPage, rowsPerPage } = this.pagination;
                const startIdx = (currentPage - 1) * rowsPerPage;
                
                if (rowsPerPage === 'all') {
                    this.displayedRisks = [...this.filteredRisks];
                } else {
                    const endIdx = startIdx + parseInt(rowsPerPage);
                    this.displayedRisks = this.filteredRisks.slice(startIdx, endIdx);
                }
            }

            setPage(page) {
                this.pagination.currentPage = page;
                this.updatePagination();
            }

            setRowsPerPage(rows) {
                this.pagination.rowsPerPage = rows === 'all' ? 'all' : parseInt(rows);
                this.pagination.currentPage = 1;
                this.updatePagination();
            }

            getTotalPages() {
                if (this.pagination.rowsPerPage === 'all') return 1;
                return Math.ceil(this.filteredRisks.length / this.pagination.rowsPerPage);
            }

            updateRiskOwnersList() {
                this.riskOwners = [...new Set(this.risks.map(r => r.riskOwner).filter(o => o))].sort();
            }

            addToHistory(action) {
                // Remove any future history if we're not at the end
                this.history = this.history.slice(0, this.historyIndex + 1);
                
                this.history.push(action);
                if (this.history.length > CONFIG.MAX_HISTORY) {
                    this.history.shift();
                } else {
                    this.historyIndex++;
                }
                
                updateHistoryButtons();
            }

            canUndo() {
                return this.historyIndex >= 0;
            }

            canRedo() {
                return this.historyIndex < this.history.length - 1;
            }

            async undo() {
                if (!this.canUndo()) return;
                
                const action = this.history[this.historyIndex];
                this.historyIndex--;
                
                // Revert the action
                await updateRiskInDB(action.before);
                await loadRisks();
                
                showToast('Change undone', 'info');
                updateHistoryButtons();
            }

            async redo() {
                if (!this.canRedo()) return;
                
                this.historyIndex++;
                const action = this.history[this.historyIndex];
                
                // Reapply the action
                await updateRiskInDB(action.after);
                await loadRisks();
                
                showToast('Change redone', 'info');
                updateHistoryButtons();
            }

            getStatistics() {
                const total = this.risks.length;
                const critical = this.risks.filter(r => r.riskRatingResidual === 'Critical').length;
                const high = this.risks.filter(r => r.riskRatingResidual === 'High').length;
                const open = this.risks.filter(r => r.riskStatus === 'Open').length;
                
                const overdue = this.risks.filter(r => {
                    const metrics = calculateDateMetrics(r.dateRaised, r.reviewDate);
                    return metrics.reviewDaysDiff < 0;
                }).length;

                return { total, critical, high, overdue, open };
            }

            getActiveFilterCount() {
                return Object.values(this.filters).filter(v => v !== '').length;
            }
        }

        const state = new RiskRegisterState();

        // =============================================
        // INDEXEDDB
        // =============================================
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                if (db) {
                    resolve(db);
                    return;
                }

                if (!window.indexedDB) {
                    reject(new Error("IndexedDB not supported in this browser."));
                    return;
                }

                const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);

                request.onerror = (e) => {
                    console.error('IndexedDB error:', e);
                    reject(e.target.error);
                };

                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };

                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(CONFIG.STORE_NAME)) {
                        const objectStore = database.createObjectStore(CONFIG.STORE_NAME, {
                            keyPath: 'riskNumber'
                        });
                        objectStore.createIndex('riskOwner', 'riskOwner', { unique: false });
                        objectStore.createIndex('riskStatus', 'riskStatus', { unique: false });
                    }
                };
            });
        }

        async function getAllRisksDB() {
            const database = await initDB();
            return new Promise((resolve, reject) => {
                const tx = database.transaction([CONFIG.STORE_NAME], 'readonly');
                const request = tx.objectStore(CONFIG.STORE_NAME).getAll();
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function getRiskByNumberDB(riskNumber) {
            const database = await initDB();
            return new Promise((resolve, reject) => {
                const tx = database.transaction([CONFIG.STORE_NAME], 'readonly');
                const request = tx.objectStore(CONFIG.STORE_NAME).get(riskNumber);
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function updateRiskInDB(risk) {
            const database = await initDB();
            return new Promise((resolve, reject) => {
                const tx = database.transaction([CONFIG.STORE_NAME], 'readwrite');
                const request = tx.objectStore(CONFIG.STORE_NAME).put(risk);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function bulkPutRisksDB(risks) {
            const database = await initDB();
            return new Promise((resolve, reject) => {
                const tx = database.transaction([CONFIG.STORE_NAME], 'readwrite');
                const store = tx.objectStore(CONFIG.STORE_NAME);
                
                const clearRequest = store.clear();
                clearRequest.onsuccess = () => {
                    risks.forEach(risk => store.put(risk));
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                };
                clearRequest.onerror = (e) => reject(e.target.error);
            });
        }

        // =============================================
        // UI UTILITIES
        // =============================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†',
                info: '‚Ñπ'
            }[type] || '‚Ñπ';
            
            toast.innerHTML = `<span>${icon}</span><span>${sanitizeHTML(message)}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, CONFIG.TOAST_DURATION);
        }

        function showLoader(message = 'Loading...') {
            let loader = document.getElementById('global-loader');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'global-loader';
                loader.innerHTML = `
                    <div class="loader-content">
                        <div class="spinner"></div>
                        <p>${sanitizeHTML(message)}</p>
                    </div>`;
                document.body.appendChild(loader);
            }
        }

        function hideLoader() {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.remove();
            }
        }

        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // =============================================
        // DATE & CALCULATION UTILITIES
        // =============================================
        function parseUKDate(str) {
            if (!str) return null;
            str = String(str).trim();
            
            let date = new Date(str);
            if (!isNaN(date.getTime()) && date.getFullYear() > 1900) return date;
            
            const parts = str.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
            if (parts) {
                date = new Date(parts[3], parts[2] - 1, parts[1]);
                if (!isNaN(date.getTime()) && date.getFullYear() > 1900) return date;
            }
            
            return null;
        }

        function getFormattedDate(value) {
            if (!value) return '';
            let date = (value instanceof Date) ? value : parseUKDate(value);
            if (!date || isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        }

        function calculateDateMetrics(dateRaised, reviewDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let ageDays = '';
            if (dateRaised) {
                const raised = new Date(dateRaised);
                ageDays = Math.max(0, Math.ceil((today - raised) / (86400000)));
            }
            
            let reviewDaysDiff = Infinity;
            let reviewClass = '';
            if (reviewDate) {
                const review = new Date(reviewDate);
                review.setHours(0, 0, 0, 0);
                reviewDaysDiff = Math.ceil((review - today) / (86400000));
                
                if (reviewDaysDiff < 0) {
                    reviewClass = 'overdue';
                } else if (reviewDaysDiff <= CONFIG.DATE_FILTERS.DUE_NEXT_WEEK) {
                    reviewClass = 'due-next-week';
                } else if (reviewDaysDiff <= CONFIG.DATE_FILTERS.DUE_SOON) {
                    reviewClass = 'due-soon';
                }
            }
            
            return { ageDays, reviewDaysDiff, reviewClass };
        }

        function getRiskRating(score) {
            if (score <= CONFIG.RISK_SCORE_THRESHOLDS.LOW) return 'Low';
            if (score <= CONFIG.RISK_SCORE_THRESHOLDS.MEDIUM) return 'Medium';
            if (score <= CONFIG.RISK_SCORE_THRESHOLDS.HIGH) return 'High';
            return 'Critical';
        }

        function getRiskRatingClass(rating) {
            const classes = {
                'Low': 'risk-rating-low',
                'Medium': 'risk-rating-medium',
                'High': 'risk-rating-high',
                'Critical': 'risk-rating-critical'
            };
            return classes[rating] || '';
        }

        function safeParseInt(value) {
            const num = parseInt(value, 10);
            return isNaN(num) ? '' : num;
        }

        function calculateRiskScore(probability, impact) {
            const p = parseInt(probability);
            const i = parseInt(impact);
            return (p && i && !isNaN(p) && !isNaN(i)) ? p * i : '';
        }

        // =============================================
        // VALIDATION
        // =============================================
        function validateRisk(risk) {
            const errors = [];
            
            if (!risk.riskItem || !risk.riskItem.trim()) {
                errors.push('Risk Item is required');
            }
            
            if (risk.reviewDate && !parseUKDate(risk.reviewDate)) {
                errors.push('Invalid review date format');
            }
            
            if (risk.probabilityResidual) {
                const p = parseInt(risk.probabilityResidual);
                if (isNaN(p) || p < 1 || p > 5) {
                    errors.push('Probability must be between 1 and 5');
                }
            }
            
            if (risk.impactResidual) {
                const i = parseInt(risk.impactResidual);
                if (isNaN(i) || i < 1 || i > 5) {
                    errors.push('Impact must be between 1 and 5');
                }
            }
            
            return errors;
        }

        // =============================================
        // DATA OPERATIONS
        // =============================================
        async function loadRisks() {
            showLoader('Loading risks...');
            
            try {
                await initDB();
                const risks = await getAllRisksDB();
                
                // Migration and cleanup
                risks.forEach(risk => {
                    if (risk.actions) {
                        risk.actionsText = risk.actions;
                        risk.notesHistory = '';
                        delete risk.actions;
                    }
                    if (risk.actionsText === undefined) risk.actionsText = '';
                    if (risk.relatedRisks === undefined) risk.relatedRisks = '';
                    if (risk.notesHistory === undefined) risk.notesHistory = '';
                    
                    // Sanitize all string fields
                    Object.keys(risk).forEach(key => {
                        if (typeof risk[key] === 'string') {
                            risk[key] = sanitizeHTML(risk[key]);
                        }
                    });
                });
                
                state.setRisks(risks);
                populateOwnerFilter();
                loadSavedFilters();
                updateStatistics();
                renderRisks();
                updateLastFileDisplay();
                
                showToast(`Loaded ${risks.length} risks successfully`, 'success');
            } catch (error) {
                console.error('Error loading risks:', error);
                showToast('Failed to load risks: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        function loadSavedFilters() {
            const savedReviewFilter = localStorage.getItem('filter_reviewDate');
            if (savedReviewFilter && ['Overdue', 'DueNextWeek', 'DueSoon'].includes(savedReviewFilter)) {
                state.filters.reviewDate = savedReviewFilter;
                document.getElementById('reviewDateFilter').value = savedReviewFilter;
            } else {
                // Default to Overdue
                state.filters.reviewDate = 'Overdue';
                document.getElementById('reviewDateFilter').value = 'Overdue';
                localStorage.setItem('filter_reviewDate', 'Overdue');
            }
            
            // Load other filters
            ['status', 'rating', 'owner'].forEach(key => {
                const saved = localStorage.getItem(`filter_${key}`);
                if (saved) {
                    state.filters[key] = saved;
                    const element = document.getElementById(`${key}Filter`);
                    if (element) element.value = saved;
                }
            });
        }

        function populateOwnerFilter() {
            const ownerFilter = document.getElementById('ownerFilter');
            const currentValue = ownerFilter.value;
            
            ownerFilter.innerHTML = '<option value="">All Owners</option>';
            
            state.riskOwners.forEach(owner => {
                const option = document.createElement('option');
                option.value = owner;
                option.textContent = owner;
                ownerFilter.appendChild(option);
            });
            
            if (state.riskOwners.includes(currentValue)) {
                ownerFilter.value = currentValue;
            }
        }

        function updateStatistics() {
            const stats = state.getStatistics();
            
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statCritical').textContent = stats.critical;
            document.getElementById('statHigh').textContent = stats.high;
            document.getElementById('statOverdue').textContent = stats.overdue;
            document.getElementById('statOpen').textContent = stats.open;
        }

        function updateFilterBadge() {
            const count = state.getActiveFilterCount();
            const container = document.getElementById('activeFiltersContainer');
            const badge = document.getElementById('filterBadge');
            
            if (count > 0) {
                container.style.display = 'flex';
                badge.textContent = count;
            } else {
                container.style.display = 'none';
            }
        }

        function updateLastFileDisplay() {
            const lastFile = localStorage.getItem('lastImportedFile') || 'None';
            document.getElementById('lastFileDisplay').innerHTML = 
                `Last Imported Source: <strong>${sanitizeHTML(lastFile)}</strong>`;
        }

        // =============================================
        // RENDERING
        // =============================================
        function renderRisks() {
            const tbody = document.querySelector('#riskTable tbody');
            tbody.innerHTML = '';
            
            updateFilterBadge();
            
            if (state.risks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="30" style="text-align:center; padding: 40px;">
                            <h3>No risks in the register</h3>
                            <p>Click "Add New Risk" to get started or load data from a file.</p>
                        </td>
                    </tr>`;
                updatePaginationControls();
                return;
            }
            
            if (state.filteredRisks.length === 0) {
                const activeFilters = state.getActiveFilterCount();
                tbody.innerHTML = `
                    <tr>
                        <td colspan="30" style="text-align:center; padding: 40px;">
                            <h3>No risks match your filters</h3>
                            <p>${state.risks.length} total risks are hidden by ${activeFilters} active filter(s).</p>
                            <button onclick="clearAllFilters()" class="btn-danger">Clear All Filters</button>
                        </td>
                    </tr>`;
                updatePaginationControls();
                return;
            }
            
            state.displayedRisks.forEach(risk => {
                const tr = tbody.insertRow();
                const metrics = calculateDateMetrics(risk.dateRaised, risk.reviewDate);
                
                // Risk Number
                createStaticCell(tr, risk.riskNumber);
                
                // Risk Item
                createStaticCell(tr, risk.riskItem);
                
                // Risk Owner (editable)
                createEditableCell(tr, risk.riskOwner, 'riskOwner', risk.riskNumber);
                
                // Rating (Residual)
                const ratingCell = tr.insertCell();
                ratingCell.innerHTML = `<div><span class="${getRiskRatingClass(risk.riskRatingResidual)}">${sanitizeHTML(risk.riskRatingResidual)}</span></div>`;
                
                // Risk Status (editable)
                createEditableCell(tr, risk.riskStatus, 'riskStatus', risk.riskNumber);
                
                // Review Date (editable)
                createEditableCell(tr, risk.reviewDate, 'reviewDate', risk.riskNumber, metrics.reviewClass);
                
                // Related Risks (editable)
                createEditableCell(tr, risk.relatedRisks, 'relatedRisks', risk.riskNumber);
                
                // Age (Days)
                createStaticCell(tr, metrics.ageDays);
                
                // Date Raised
                createStaticCell(tr, risk.dateRaised);
                
                // Raised By
                createStaticCell(tr, risk.raisedBy);
                
                // Impact Statement
                createStaticCell(tr, risk.impactStatement);
                
                // Controls/Mitigations
                createStaticCell(tr, risk.controlsMitigations);
                
                // Probability (Initial)
                createStaticCell(tr, risk.probabilityInitial);
                
                // Impact (Initial)
                createStaticCell(tr, risk.impactInitial);
                
                // Score (Initial)
                createStaticCell(tr, risk.riskScoreInitial);
                
                // Rating (Initial)
                const ratingInitialCell = tr.insertCell();
                ratingInitialCell.innerHTML = `<div><span class="${getRiskRatingClass(risk.riskRatingInitial)}">${sanitizeHTML(risk.riskRatingInitial)}</span></div>`;
                
                // Probability (Residual)
                createStaticCell(tr, risk.probabilityResidual);
                
                // Impact (Residual)
                createStaticCell(tr, risk.impactResidual);
                
                // Score (Residual)
                createStaticCell(tr, risk.riskScoreResidual);
                
                // Actions Text (editable)
                createEditableCell(tr, risk.actionsText, 'actionsText', risk.riskNumber);
                
                // Notes / History
                createStaticCell(tr, risk.notesHistory);
                
                // Impacted Area
                createStaticCell(tr, risk.impactedArea);
                
                // Risk Category
                createStaticCell(tr, risk.riskCategory);
                
                // Related Laws/Regulations
                createStaticCell(tr, risk.relatedLaws);
                
                // Non-Compliance Impact
                createStaticCell(tr, risk.nonComplianceImpact);
                
                // Outcome Definition
                createStaticCell(tr, risk.outcomeDefinition);
                
                // Source Department
                createStaticCell(tr, risk.sourceDepartment);
                
                // Source Last Review Date
                createStaticCell(tr, risk.sourceLastReviewDate);
                
                // Source Due Date
                createStaticCell(tr, risk.sourceDueDate);
                
                // Actions
                const actionsCell = tr.insertCell();
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'edit-btn';
                editBtn.onclick = () => window.location.href = `risk_form.html?id=${risk.riskNumber}`;
                actionsCell.appendChild(editBtn);
            });
            
            updatePaginationControls();
        }

        function createStaticCell(row, value) {
            const cell = row.insertCell();
            const div = document.createElement('div');
            div.textContent = value || '';
            cell.appendChild(div);
            return cell;
        }

        function createEditableCell(row, value, key, riskNumber, additionalClass = '') {
            const cell = row.insertCell();
            cell.setAttribute('data-risk-number', riskNumber);
            cell.setAttribute('data-key', key);
            
            const div = document.createElement('div');
            div.textContent = value || '';
            if (additionalClass) {
                div.className = additionalClass;
            }
            
            cell.appendChild(div);
            return cell;
        }

        // =============================================
        // INLINE EDITING
        // =============================================
        let editingSaveTimeout;

        async function handleInlineEdit(event) {
            const cell = event.target.closest('td[data-key]');
            if (!cell) return;
            if (cell.querySelector('input, select')) return;
            
            const riskNumber = cell.getAttribute('data-risk-number');
            const key = cell.getAttribute('data-key');
            
            const risk = await getRiskByNumberDB(riskNumber);
            if (!risk) {
                showToast('Risk not found', 'error');
                await loadRisks();
                return;
            }
            
            const previousState = JSON.parse(JSON.stringify(risk));
            const currentValue = risk[key] || '';
            
            const contentDiv = cell.querySelector('div');
            contentDiv.style.display = 'none';
            
            let input;
            
            if (key === 'riskStatus') {
                input = document.createElement('select');
                input.className = 'inline-edit';
                RISK_STATUSES.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentValue) option.selected = true;
                    input.appendChild(option);
                });
            } else if (key === 'riskOwner') {
                input = document.createElement('select');
                input.className = 'inline-edit';
                
                const owners = [...state.riskOwners];
                if (currentValue && !owners.includes(currentValue)) {
                    owners.push(currentValue);
                }
                
                input.innerHTML = '<option value="">-- Select --</option>';
                owners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    if (owner === currentValue) option.selected = true;
                    input.appendChild(option);
                });
            } else if (key === 'reviewDate') {
                input = document.createElement('input');
                input.type = 'date';
                input.className = 'inline-edit';
                input.value = currentValue;
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'inline-edit';
                input.value = currentValue;
            }
            
            cell.appendChild(input);
            input.focus();
            
            const saveEdit = async (newValue) => {
                clearTimeout(editingSaveTimeout);
                
                if (!cell.contains(input)) return;
                
                editingSaveTimeout = setTimeout(async () => {
                    const sanitizedValue = typeof newValue === 'string' ? sanitizeHTML(newValue) : newValue;
                    
                    if (String(sanitizedValue) !== String(currentValue)) {
                        risk[key] = key.includes('Date') ? getFormattedDate(sanitizedValue) : sanitizedValue;
                        
                        // Validate
                        const errors = validateRisk(risk);
                        if (errors.length > 0) {
                            showToast('Validation error: ' + errors[0], 'error');
                            contentDiv.style.display = '';
                            if (cell.contains(input)) cell.removeChild(input);
                            return;
                        }
                        
                        try {
                            await updateRiskInDB(risk);
                            
                            // Add to history
                            state.addToHistory({
                                type: 'update',
                                riskNumber: risk.riskNumber,
                                before: previousState,
                                after: JSON.parse(JSON.stringify(risk)),
                                timestamp: Date.now()
                            });
                            
                            await loadRisks();
                            showToast('Risk updated successfully', 'success');
                        } catch (error) {
                            console.error('Error updating risk:', error);
                            showToast('Failed to update risk', 'error');
                            contentDiv.style.display = '';
                        }
                    } else {
                        contentDiv.style.display = '';
                    }
                    
                    if (cell.contains(input)) {
                        cell.removeChild(input);
                    }
                }, CONFIG.DEBOUNCE_MS);
            };
            
            input.addEventListener('change', (e) => saveEdit(e.target.value));
            input.addEventListener('blur', (e) => saveEdit(e.target.value));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit(e.target.value);
                } else if (e.key === 'Escape') {
                    contentDiv.style.display = '';
                    if (cell.contains(input)) cell.removeChild(input);
                }
            });
        }

        // Use event delegation for inline editing
        document.addEventListener('DOMContentLoaded', () => {
            const tbody = document.querySelector('#riskTable tbody');
            tbody.addEventListener('dblclick', handleInlineEdit);
        });

        // =============================================
        // PAGINATION
        // =============================================
        function updatePaginationControls() {
            const totalPages = state.getTotalPages();
            const currentPage = state.pagination.currentPage;
            const rowsPerPage = state.pagination.rowsPerPage;
            const totalRisks = state.filteredRisks.length;
            
            // Update info
            const startIdx = rowsPerPage === 'all' ? 1 : (currentPage - 1) * rowsPerPage + 1;
            const endIdx = rowsPerPage === 'all' ? totalRisks : Math.min(currentPage * rowsPerPage, totalRisks);
            
            document.getElementById('paginationInfo').textContent = 
                totalRisks > 0 ? `Showing ${startIdx}-${endIdx} of ${totalRisks} risks` : 'No risks to display';
            
            // Update controls
            const controls = document.getElementById('paginationControls');
            controls.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Äπ Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                state.setPage(currentPage - 1);
                renderRisks();
            };
            controls.appendChild(prevBtn);
            
            // Page numbers
            const maxPages = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.className = 'page-number';
                firstBtn.onclick = () => {
                    state.setPage(1);
                    renderRisks();
                };
                controls.appendChild(firstBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 10px';
                    controls.appendChild(ellipsis);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = 'page-number' + (i === currentPage ? ' active' : '');
                pageBtn.onclick = () => {
                    state.setPage(i);
                    renderRisks();
                };
                controls.appendChild(pageBtn);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 10px';
                    controls.appendChild(ellipsis);
                }
                
                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages;
                lastBtn.className = 'page-number';
                lastBtn.onclick = () => {
                    state.setPage(totalPages);
                    renderRisks();
                };
                controls.appendChild(lastBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next ‚Ä∫';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                state.setPage(currentPage + 1);
                renderRisks();
            };
            controls.appendChild(nextBtn);
        }

        // =============================================
        // HISTORY (UNDO/REDO)
        // =============================================
        function updateHistoryButtons() {
            document.getElementById('undoButton').disabled = !state.canUndo();
            document.getElementById('redoButton').disabled = !state.canRedo();
        }

        // =============================================
        // IMPORT/EXPORT
        // =============================================
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function getNextRiskNumber(risks) {
            if (!risks.length) return 1;
            return risks.reduce((max, r) => Math.max(max, parseInt(r.riskNumber) || 0), 0) + 1;
        }

        async function ensureUniqueRiskNumbers(newRisks) {
            const existing = await getAllRisksDB();
            const seenNumbers = new Set(existing.map(r => String(r.riskNumber)));
            let nextNumber = getNextRiskNumber(existing);
            
            for (const risk of newRisks) {
                let riskNum = String(risk.riskNumber).trim();
                
                if (!riskNum || isNaN(parseInt(riskNum)) || seenNumbers.has(riskNum)) {
                    riskNum = String(nextNumber);
                }
                
                if (parseInt(riskNum) >= nextNumber) {
                    nextNumber = parseInt(riskNum) + 1;
                }
                
                risk.riskNumber = riskNum;
                seenNumbers.add(riskNum);
                
                // Standardize dates
                risk.dateRaised = getFormattedDate(risk.dateRaised);
                risk.reviewDate = getFormattedDate(risk.reviewDate);
                risk.sourceLastReviewDate = getFormattedDate(risk.sourceLastReviewDate);
                risk.sourceDueDate = getFormattedDate(risk.sourceDueDate);
                
                // Ensure fields exist
                if (risk.relatedRisks === undefined) risk.relatedRisks = '';
                if (risk.actionsText === undefined) risk.actionsText = '';
                if (risk.notesHistory === undefined) risk.notesHistory = '';
                
                // Sanitize all string fields
                Object.keys(risk).forEach(key => {
                    if (typeof risk[key] === 'string') {
                        risk[key] = sanitizeHTML(risk[key]);
                    }
                });
                
                // Validate
                const errors = validateRisk(risk);
                if (errors.length > 0) {
                    console.warn(`Risk ${risk.riskNumber} has validation errors:`, errors);
                }
            }
            
            return newRisks;
        }

        async function loadFromJSON(text) {
            const data = JSON.parse(text);
            if (!Array.isArray(data)) {
                throw new Error('Invalid JSON format: expected an array');
            }
            
            const validRisks = await ensureUniqueRiskNumbers(data);
            await bulkPutRisksDB(validRisks);
            await loadRisks();
            
            return validRisks.length;
        }

        function parseCsvLine(line) {
            const result = [];
            let inQuotes = false;
            let current = '';
            
            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result.map(s => s.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
        }

        function parseCsv(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length < 2) return [];
            
            const headers = parseCsvLine(lines[0]);
            const risks = [];
            
            const headerMap = {
                'Risk Number': 'riskNumber',
                'Risk Ref.': 'riskNumber',
                'Date Raised': 'dateRaised',
                'Raised By': 'raisedBy',
                'Assigned To': 'raisedBy',
                'Risk Item': 'riskItem',
                'Risk': 'riskItem',
                'Impact Statement': 'impactStatement',
                'Description of Impact': 'impactStatement',
                'Risk Owner': 'riskOwner',
                'Reviewed By': 'riskOwner',
                'Review Date': 'reviewDate',
                'Next Review Date': 'reviewDate',
                'Actions Text (Current)': 'actionsText',
                'Actions': 'actionsText',
                'Notes & Comments': 'actionsText',
                'Notes / History': 'notesHistory',
                'Related Risks': 'relatedRisks',
                'Risk Status': 'riskStatus',
                'Probability (Initial)': 'probabilityInitial',
                'Likelihood': 'probabilityInitial',
                'Impact (Initial)': 'impactInitial',
                'Impact': 'impactInitial',
                'Probability (Residual)': 'probabilityResidual',
                'Likelihood Total': 'probabilityResidual',
                'Impact (Residual)': 'impactResidual',
                'Impact Total': 'impactResidual',
                'Controls/Mitigations': 'controlsMitigations',
                'Source Department': 'sourceDepartment',
                'Source Last Review Date': 'sourceLastReviewDate',
                'Source Due Date': 'sourceDueDate',
                'Risk Issue': 'riskIssue',
                'Impacted Area': 'impactedArea',
                'Risk Category': 'riskCategory',
                'Related Laws/Regulations': 'relatedLaws',
                'Non-Compliance Impact': 'nonComplianceImpact',
                'Outcome Definition': 'outcomeDefinition'
            };
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCsvLine(lines[i]);
                if (values.length !== headers.length) {
                    console.warn(`Line ${i + 1} has ${values.length} fields, expected ${headers.length}`);
                    continue;
                }
                
                const rawData = {};
                headers.forEach((header, idx) => {
                    rawData[header] = values[idx];
                });
                
                const pi = safeParseInt(rawData['Probability (Initial)'] || rawData['Likelihood']);
                const ii = safeParseInt(rawData['Impact (Initial)'] || rawData['Impact']);
                const pr = safeParseInt(rawData['Probability (Residual)'] || rawData['Likelihood Total']);
                const ir = safeParseInt(rawData['Impact (Residual)'] || rawData['Impact Total']);
                
                const risk = {
                    riskNumber: rawData['Risk Number'] || rawData['Risk Ref.'] || '',
                    dateRaised: getFormattedDate(rawData['Date Raised']),
                    raisedBy: rawData['Raised By'] || rawData['Assigned To'] || '',
                    riskItem: rawData['Risk Item'] || rawData['Risk'] || '',
                    impactStatement: rawData['Impact Statement'] || rawData['Description of Impact'] || '',
                    riskOwner: rawData['Risk Owner'] || rawData['Reviewed By'] || '',
                    reviewDate: getFormattedDate(rawData['Review Date'] || rawData['Next Review Date']),
                    actionsText: rawData['Actions Text (Current)'] || rawData['Actions'] || rawData['Notes & Comments'] || '',
                    notesHistory: rawData['Notes / History'] || '',
                    relatedRisks: rawData['Related Risks'] || '',
                    riskStatus: rawData['Risk Status'] || (rawData['Closed Date'] ? 'Closed' : 'Open'),
                    probabilityInitial: pi,
                    impactInitial: ii,
                    riskScoreInitial: calculateRiskScore(pi, ii),
                    riskRatingInitial: getRiskRating(pi * ii),
                    probabilityResidual: pr,
                    impactResidual: ir,
                    riskScoreResidual: calculateRiskScore(pr, ir),
                    riskRatingResidual: getRiskRating(pr * ir),
                    controlsMitigations: rawData['Controls/Mitigations'] || '',
                    sourceDepartment: rawData['Source Department'] || '',
                    sourceLastReviewDate: getFormattedDate(rawData['Source Last Review Date']),
                    sourceDueDate: getFormattedDate(rawData['Source Due Date']),
                    riskIssue: rawData['Risk Issue'] || '',
                    impactedArea: rawData['Impacted Area'] || '',
                    riskCategory: rawData['Risk Category'] || '',
                    relatedLaws: rawData['Related Laws/Regulations'] || '',
                    nonComplianceImpact: rawData['Non-Compliance Impact'] || '',
                    outcomeDefinition: rawData['Outcome Definition'] || ''
                };
                
                risks.push(risk);
            }
            
            return risks;
        }

        async function loadFromCSV(text) {
            const data = parseCsv(text);
            const validRisks = await ensureUniqueRiskNumbers(data);
            await bulkPutRisksDB(validRisks);
            await loadRisks();
            
            return validRisks.length;
        }

        function convertToCSV(risks) {
            const headers = [
                "Risk Number", "Date Raised", "Raised By", "Risk Item", "Risk Issue",
                "Impact Statement", "Impacted Area", "Risk Category", "Related Laws/Regulations",
                "Non-Compliance Impact", "Probability (Initial)", "Impact (Initial)",
                "Initial Risk Score", "Initial Risk Rating", "Outcome Definition",
                "Risk Owner", "Controls/Mitigations", "Probability (Residual)",
                "Impact (Residual)", "Residual Risk Score", "Residual Risk Rating",
                "Actions Text (Current)", "Notes / History", "Related Risks",
                "Risk Status", "Review Date", "Age (Days)", "Source Department",
                "Source Last Review Date", "Source Due Date"
            ];
            
            const headerRow = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            
            const dataRows = risks.map(risk => {
                const age = calculateDateMetrics(risk.dateRaised).ageDays;
                
                const values = [
                    risk.riskNumber, risk.dateRaised, risk.raisedBy, risk.riskItem,
                    risk.riskIssue, risk.impactStatement, risk.impactedArea,
                    risk.riskCategory, risk.relatedLaws, risk.nonComplianceImpact,
                    risk.probabilityInitial, risk.impactInitial, risk.riskScoreInitial,
                    risk.riskRatingInitial, risk.outcomeDefinition, risk.riskOwner,
                    risk.controlsMitigations, risk.probabilityResidual, risk.impactResidual,
                    risk.riskScoreResidual, risk.riskRatingResidual, risk.actionsText,
                    risk.notesHistory, risk.relatedRisks, risk.riskStatus,
                    risk.reviewDate, age, risk.sourceDepartment, risk.sourceLastReviewDate,
                    risk.sourceDueDate
                ];
                
                return values.map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(',');
            });
            
            return [headerRow, ...dataRows].join('\n');
        }

        // =============================================
        // EVENT HANDLERS
        // =============================================
        function clearAllFilters() {
            state.clearAllFilters();
            
            // Reset UI
            document.getElementById('statusFilter').value = '';
            document.getElementById('ratingFilter').value = '';
            document.getElementById('ownerFilter').value = '';
            document.getElementById('reviewDateFilter').value = '';
            document.getElementById('globalSearch').value = '';
            document.getElementById('clearSearch').classList.remove('visible');
            
            renderRisks();
            showToast('All filters cleared', 'info');
        }

        // Search functionality
        const searchInput = document.getElementById('globalSearch');
        const clearSearchBtn = document.getElementById('clearSearch');

        searchInput.addEventListener('input', debounce((e) => {
            const value = e.target.value;
            state.setFilter('search', value);
            clearSearchBtn.classList.toggle('visible', value.length > 0);
            renderRisks();
        }, CONFIG.DEBOUNCE_MS));

        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            state.setFilter('search', '');
            clearSearchBtn.classList.remove('visible');
            renderRisks();
            searchInput.focus();
        });

        // Filter changes
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            state.setFilter('status', e.target.value);
            renderRisks();
        });

        document.getElementById('ratingFilter').addEventListener('change', (e) => {
            state.setFilter('rating', e.target.value);
            renderRisks();
        });

        document.getElementById('ownerFilter').addEventListener('change', (e) => {
            state.setFilter('owner', e.target.value);
            renderRisks();
        });

        document.getElementById('reviewDateFilter').addEventListener('change', (e) => {
            state.setFilter('reviewDate', e.target.value);
            renderRisks();
        });

        document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);

        // Rows per page
        document.getElementById('rowsPerPage').addEventListener('change', (e) => {
            state.setRowsPerPage(e.target.value);
            renderRisks();
        });

        // History buttons
        document.getElementById('undoButton').addEventListener('click', async () => {
            await state.undo();
        });

        document.getElementById('redoButton').addEventListener('click', async () => {
            await state.redo();
        });

        // File operations
        document.getElementById('loadDataButton').addEventListener('click', async () => {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                showToast('Please select a file first', 'warning');
                return;
            }
            
            const file = fileInput.files[0];
            const filename = file.name.toLowerCase();
            
            showLoader('Loading file...');
            
            try {
                const existingRisks = await getAllRisksDB();
                if (existingRisks.length > 0) {
                    if (!confirm('This will replace all existing data. Continue?')) {
                        hideLoader();
                        return;
                    }
                }
                
                const text = await file.text();
                let count;
                
                if (filename.endsWith('.json')) {
                    count = await loadFromJSON(text);
                } else if (filename.endsWith('.csv')) {
                    count = await loadFromCSV(text);
                } else {
                    throw new Error('Invalid file type. Please use JSON or CSV.');
                }
                
                localStorage.setItem('lastImportedFile', file.name);
                updateLastFileDisplay();
                showToast(`Successfully loaded ${count} risks`, 'success');
            } catch (error) {
                console.error('Error loading file:', error);
                showToast('Failed to load file: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        });

        document.getElementById('loadDefaultFileButton').addEventListener('click', async () => {
            showLoader('Loading default data...');
            
            try {
                const existingRisks = await getAllRisksDB();
                if (existingRisks.length > 0) {
                    if (!confirm('This will replace all existing data. Continue?')) {
                        hideLoader();
                        return;
                    }
                }
                
                const response = await fetch(CONFIG.DEFAULT_FILE_PATH);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                const count = await loadFromJSON(text);
                
                localStorage.setItem('lastImportedFile', 'Default System Data');
                updateLastFileDisplay();
                showToast(`Successfully loaded ${count} default risks`, 'success');
            } catch (error) {
                console.error('Error loading default file:', error);
                showToast('Failed to load default data: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        });

        document.getElementById('saveJsonButton').addEventListener('click', () => {
            if (state.risks.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            const filename = `risk_register_${getFormattedDate(new Date())}.json`;
            downloadFile(JSON.stringify(state.risks, null, 2), filename, 'application/json');
            showToast('JSON file downloaded', 'success');
        });

        document.getElementById('saveCsvButton').addEventListener('click', () => {
            if (state.risks.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            const csv = convertToCSV(state.risks);
            const filename = `risk_register_${getFormattedDate(new Date())}.csv`;
            downloadFile(csv, filename, 'text/csv');
            showToast('CSV file downloaded', 'success');
        });

        document.getElementById('addNewRiskButton').addEventListener('click', () => {
            window.location.href = 'risk_form.html';
        });

        document.getElementById('manageDataButton').addEventListener('click', () => {
            window.location.href = 'data_management.html';
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Z = Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                if (state.canUndo()) {
                    state.undo();
                }
            }
            
            // Ctrl/Cmd + Shift + Z = Redo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                if (state.canRedo()) {
                    state.redo();
                }
            }
            
            // Ctrl/Cmd + F = Focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('globalSearch').focus();
            }
            
            // ? = Toggle keyboard hints
            if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
                const hints = document.getElementById('shortcutsHint');
                hints.classList.toggle('visible');
            }
        });

        // =============================================
        // INITIALIZATION
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Risk Register Enhanced Edition - Initializing...');
            
            // Set default filter if not set
            if (!localStorage.getItem('filter_reviewDate')) {
                localStorage.setItem('filter_reviewDate', 'Overdue');
            }
            
            await loadRisks();
            updateHistoryButtons();
            
            console.log('Risk Register ready.');
        });
    </script>
</body>
</html>
