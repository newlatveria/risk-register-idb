<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Register - Main View</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2 {
            color: #0056b3;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* --- TOP ACTIONS --- */
        .top-actions {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        
        /* --- FILTER CONTROLS --- */
        .filter-actions {
            display: flex;
            flex-wrap: wrap; 
            gap: 20px;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .filter-actions div {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-actions label {
            font-weight: bold;
            color: #555;
        }

        /* --- DATA MANAGEMENT SECTION --- */
        .data-management-section {
            padding: 20px;
            margin-top: 20px;
            border-top: 2px solid #007bff;
            background-color: #e9f5ff;
            border-radius: 8px;
        }
        .data-management-section h2 {
            margin-top: 0;
            color: #0056b3;
            border-bottom: 1px solid #007bff;
            padding-bottom: 5px;
        }
        
        /* File Info Style */
        .file-info {
            font-weight: bold;
            color: #555;
            margin-bottom: 15px;
            padding: 8px 12px;
            background-color: #fff;
            border-left: 4px solid #28a745;
            border-radius: 2px;
            display: inline-block;
        }

        .file-controls-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        .file-controls-group > div {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        /* --- BUTTONS & INPUTS --- */
        button, select {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        select {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ccc;
            padding: 8px 10px;
        }
        input[type="file"] {
            padding: 5px;
            border: 1px solid #ccc;
            background-color: #eee;
            border-radius: 4px;
            cursor: pointer;
        }
        input.inline-edit, select.inline-edit {
            padding: 4px;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            border: 1px solid #007bff;
            background-color: #fff;
        }
        
        /* Specific button styling */
        #addNewRiskButton { background-color: #28a745; }
        #addNewRiskButton:hover { background-color: #1e7e34; }
        #manageDataButton { background-color: #d9534f; }
        #manageDataButton:hover { background-color: #c9302c; }
        #loadDataButton { background-color: #5cb85c; position: relative; min-width: 120px; }
        #loadDataButton:hover { background-color: #4cae4c; }
        #loadDefaultFileButton { background-color: #ff9800; position: relative; min-width: 120px; }
        #loadDefaultFileButton:hover { background-color: #e68900; }
        #saveJsonButton { background-color: #007bff; }
        #saveJsonButton:hover { background-color: #0056b3; }
        #saveCsvButton { background-color: #f0ad4e; }
        #saveCsvButton:hover { background-color: #ec971f; }

        /* --- Loading Indicator --- */
        .loading-indicator {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff; 
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 5px;
        }
        #loadDataButton.loading .button-text, #loadDefaultFileButton.loading .button-text {
            visibility: hidden;
            display: block;
        }
        #loadDataButton.loading .loading-indicator, #loadDefaultFileButton.loading .loading-indicator {
            display: inline-block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- SCROLL CONTAINER & TABLE STYLES --- */
        .table-scroll-container {
            max-height: 480px; 
            overflow-y: scroll;
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }
        table thead th {
            background-color: #007bff;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        table tbody td {
            padding: 0; 
            border: 1px solid #ddd;
            vertical-align: top;
            height: 40px; 
        }
        table tbody td > div {
            padding: 10px;
            height: 100%;
            box-sizing: border-box;
        }
        table tbody tr:nth-child(even) { background-color: #f2f2f2; }
        table tbody tr:hover { background-color: #e9e9e9; }
        
        .edit-btn {
            background-color: #ffc107;
            color: #333;
            margin-right: 5px;
            padding: 6px 10px;
            font-size: 0.9em;
            margin-top: 0;
        }
        .edit-btn:hover { background-color: #e0a800; }
        
        /* Risk Rating Classes */
        .risk-rating-low { background-color: #d4edda; color: #155724; }
        .risk-rating-medium { background-color: #fff3cd; color: #856404; }
        .risk-rating-high { background-color: #f8d7da; color: #721c24; }
        .risk-rating-critical { background-color: #6c757d; color: white; }
        
        /* Sticky Columns CSS */
        #riskTable th:first-child, #riskTable td:first-child,
        #riskTable th:last-child, #riskTable td:last-child {
            position: sticky;
            z-index: 11;
        }
        #riskTable th:first-child, #riskTable td:first-child { left: 0; }
        #riskTable th:last-child, #riskTable td:last-child { right: 0; }
        #riskTable th:first-child, #riskTable th:last-child { background-color: #007bff; }
        #riskTable tbody tr:nth-child(even) td:first-child, #riskTable tbody tr:nth-child(even) td:last-child { background-color: #f2f2f2; }
        #riskTable tbody tr:nth-child(odd) td:first-child, #riskTable tbody tr:nth-child(odd) td:last-child { background-color: #fff; }

        /* Review Date Color Coding */
        .due-soon { background-color: #ffeb3b; } 
        .due-next-week { background-color: #ffc107; } 
        .overdue { background-color: #f44336; color: white; } 
    </style>
</head>
<body>
    <div class="container">
        <h1>Risk Register</h1>

        <div class="top-actions">
            <button id="addNewRiskButton">‚ûï Add New Risk</button>
            <button onclick="window.location.href='all_risks.html'" style="background-color: #17a2b8;">üìÑ View Full Report</button>
            <button onclick="window.location.href='risk_map.html'" style="background-color: #6610f2;">üï∏Ô∏è View Risk Map</button>
            <button id="manageDataButton" title="Access administrative controls for data deletion and maintenance.">
                Manage Data (Advanced)
            </button>
        </div>

        <div class="filter-actions">
            <div>
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" onchange="filterTable()">
                    <option value="">All</option>
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Closed">Closed</option>
                    <option value="On Hold">On Hold</option>
                </select>
            </div>
            <div>
                <label for="ratingFilter">Residual Rating:</label>
                <select id="ratingFilter" onchange="filterTable()">
                    <option value="">All Ratings</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div>
                <label for="ownerFilter">Risk Owner:</label>
                <select id="ownerFilter" onchange="filterTable()">
                    <option value="">All Owners</option>
                </select>
            </div>
            <div>
                <label for="reviewDateFilter">Review Date:</label>
                <select id="reviewDateFilter" onchange="filterTable()">
                    <option value="">Any Time</option>
                    <option value="Overdue">Overdue</option>
                    <option value="DueNextWeek">Due in 0-7 Days</option>
                    <option value="DueSoon">Due in 7-28 Days</option> 
                </select>
            </div>
        </div>

        <div class="table-scroll-container">
            <table id="riskTable">
                <thead>
                    <tr>
                        <th class="sticky-header">Risk Number</th>
                        <th class="sticky-header">Risk Item</th>
                        <th class="sticky-header" data-key="riskOwner">Risk Owner</th>
                        <th class="sticky-header">Rating (Residual)</th>
                        <th class="sticky-header" data-key="riskStatus">Risk Status</th>
                        <th class="sticky-header" data-key="reviewDate">Review Date</th>
                        
                        <th class="sticky-header" data-key="relatedRisks">Linked Risks</th>

                        <th class="sticky-header">Age (Days)</th>
                        <th class="sticky-header">Date Raised</th>
                        <th class="sticky-header">Raised By</th>
                        <th class="sticky-header">Impact Statement</th>
                        <th class="sticky-header">Controls/Mitigations</th>
                        <th class="sticky-header">Prob (Initial)</th>
                        <th class="sticky-header">Impact (Initial)</th>
                        <th class="sticky-header">Score (Initial)</th>
                        <th class="sticky-header">Rating (Initial)</th>
                        <th class="sticky-header">Prob (Residual)</th>
                        <th class="sticky-header">Impact (Residual)</th>
                        <th class="sticky-header">Score (Residual)</th>
                        <th class="sticky-header" data-key="actionsText">Actions Text (Current)</th>
                        <th class="sticky-header">Notes / History</th>
                        
                        <th class="sticky-header">Impacted Area</th>
                        <th class="sticky-header">Risk Category</th>
                        <th class="sticky-header">Related Laws/Regs</th>
                        <th class="sticky-header">Non-Compliance Impact</th>
                        <th class="sticky-header">Outcome Definition</th>
                        <th class="sticky-header" style="background-color: #8c72a8;">Source Department</th>
                        <th class="sticky-header" style="background-color: #8c72a8;">Source Last Review Date</th>
                        <th class="sticky-header" style="background-color: #8c72a8;">Source Due Date</th>
                        
                        <th class="sticky-header">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        
        <div class="data-management-section">
            <h2>Data Import / Export</h2>
            
            <p id="lastFileDisplay" class="file-info">Last Imported Source: None</p>
            <p>Loading a file will **replace all existing data** in the register.</p>
            
            <div class="file-controls-group">
                <div class="load-controls">
                    <input type="file" id="fileInput" accept=".json, .csv" title="Select either a JSON or CSV file to load data.">
                    <button id="loadDataButton" title="Load data from the selected file (JSON or CSV).">
                        <span class="button-text">Load Data (File)</span>
                        <div class="loading-indicator"></div>
                    </button>
                    <button id="loadDefaultFileButton" title="Load the default risk register file from /data/default_risks.json.">
                        <span class="button-text">Load Default</span>
                        <div class="loading-indicator"></div>
                    </button>
                </div>
            </div>
            
            <div class="file-controls-group">
                <div class="save-controls">
                    <button id="saveJsonButton">Save as JSON</button>
                    <button id="saveCsvButton">Save as CSV</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // === MODULE 1: IndexedDB Configuration ===
        const DB_NAME = 'RiskRegisterDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'risks';
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                if (db) { resolve(db); return; }
                if (!window.indexedDB) { reject(new Error("IndexedDB not supported.")); return; }
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => reject(e.target.error);
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'riskNumber' });
                        objectStore.createIndex('riskOwner', 'riskOwner', { unique: false });
                    }
                };
            });
        }

        async function getAllRisksDB() {
            const db = await initDB();
            return new Promise((res, rej) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const req = tx.objectStore(STORE_NAME).getAll();
                req.onsuccess = (e) => res(e.target.result);
                req.onerror = (e) => rej(e.target.error);
            });
        }
        
        async function getRiskByNumberDB(riskNumber) {
            const db = await initDB();
            return new Promise((res, rej) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const req = tx.objectStore(STORE_NAME).get(riskNumber);
                req.onsuccess = (e) => res(e.target.result);
                req.onerror = (e) => rej(e.target.error);
            });
        }

        async function updateRiskInDB(risk) {
            const db = await initDB();
            return new Promise((res, rej) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const req = tx.objectStore(STORE_NAME).put(risk); 
                req.onsuccess = () => res();
                req.onerror = (e) => rej(e.target.error);
            });
        }
        
        async function bulkPutRisksDB(risks) {
            const db = await initDB();
            return new Promise((res, rej) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const clearReq = store.clear();
                
                clearReq.onsuccess = () => {
                    risks.forEach(risk => store.put(risk));
                    tx.oncomplete = () => res();
                    tx.onerror = (e) => rej(e.target.error);
                };
                clearReq.onerror = (e) => rej(e.target.error);
            });
        }

        // === MODULE 2: Variables ===
        const riskTableBody = document.querySelector('#riskTable tbody');
        const fileInput = document.getElementById('fileInput'); 
        const loadDataButton = document.getElementById('loadDataButton'); 
        const loadDefaultFileButton = document.getElementById('loadDefaultFileButton'); 
        const saveCsvButton = document.getElementById('saveCsvButton');
        const saveJsonButton = document.getElementById('saveJsonButton');
        const lastFileDisplay = document.getElementById('lastFileDisplay');
        
        const statusFilter = document.getElementById('statusFilter');
        const ratingFilter = document.getElementById('ratingFilter');
        const ownerFilter = document.getElementById('ownerFilter');
        const reviewDateFilter = document.getElementById('reviewDateFilter');
        
        const DEFAULT_RISK_FILE_PATH = 'data/default_risks.json'; 
        let risks = []; 
        let riskOwners = []; 
        const RISK_STATUSES = ["Open", "In Progress", "Closed", "On Hold"];

        // UPDATED CSV HEADER MAP (Includes Related Risks)
        const csvHeaders = [
            "Risk Number", "Date Raised", "Raised By", "Risk Item", "Risk Issue", "Impact Statement",
            "Impacted Area", "Risk Category", "Related Laws/Regulations", "Non-Compliance Impact",
            "Probability (Initial)", "Impact (Initial)", "Initial Risk Score", "Initial Risk Rating", 
            "Outcome Definition", "Risk Owner", "Controls/Mitigations", 
            "Probability (Residual)", "Impact (Residual)", "Residual Risk Score", "Residual Risk Rating", 
            "Actions Text (Current)", "Notes / History", 
            "Related Risks", // ADDED
            "Risk Status", "Review Date", "Age (Days)",
            "Source Department", "Source Last Review Date", "Source Due Date"
        ];
        const riskKeyToCsvHeaderMap = {
            riskNumber: "Risk Number", dateRaised: "Date Raised", raisedBy: "Raised By", riskItem: "Risk Item", 
            riskIssue: "Risk Issue", impactStatement: "Impact Statement", impactedArea: "Impacted Area", 
            riskCategory: "Risk Category", relatedLaws: "Related Laws/Regulations", nonComplianceImpact: "Non-Compliance Impact", 
            probabilityInitial: "Probability (Initial)", impactInitial: "Impact (Initial)", riskScoreInitial: "Initial Risk Score", 
            riskRatingInitial: "Initial Risk Rating", outcomeDefinition: "Outcome Definition", riskOwner: "Risk Owner", 
            controlsMitigations: "Controls/Mitigations", probabilityResidual: "Probability (Residual)", impactResidual: "Impact (Residual)", 
            riskScoreResidual: "Residual Risk Score", riskRatingResidual: "Residual Risk Rating", 
            actionsText: "Actions Text (Current)", notesHistory: "Notes / History", 
            relatedRisks: "Related Risks", // ADDED
            riskStatus: "Risk Status", reviewDate: "Review Date",
            sourceDepartment: "Source Department", sourceLastReviewDate: "Source Last Review Date", sourceDueDate: "Source Due Date"
        };
        const csvHeaderToRiskKeyMap = Object.fromEntries(Object.entries(riskKeyToCsvHeaderMap).map(([k,v])=>[v,k]));

        // === MODULE 3: Utils ===
        function parseUKDate(str) {
            if(!str) return null;
            str = String(str).trim();
            let d = new Date(str);
            if(!isNaN(d.getTime()) && d.getFullYear()>1900) return d;
            const p = str.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
            if(p) { d=new Date(p[3],p[2]-1,p[1]); if(!isNaN(d.getTime()) && d.getFullYear()>1900) return d; }
            return null;
        }
        function getFormattedDate(v) {
            if(!v) return '';
            let d = (v instanceof Date) ? v : parseUKDate(v);
            if(!d || isNaN(d.getTime())) return '';
            return d.toISOString().split('T')[0];
        }
        function getRiskRatingClass(r) {
            if(r==='Low') return 'risk-rating-low';
            if(r==='Medium') return 'risk-rating-medium';
            if(r==='High') return 'risk-rating-high';
            if(r==='Critical') return 'risk-rating-critical';
            return '';
        }
        function calculateDateMetrics(dr, rd) {
            const today = new Date(); today.setHours(0,0,0,0);
            let age = ''; if(dr){ const d=new Date(dr); age=Math.max(0,Math.ceil((today-d)/(86400000))); }
            let diff=Infinity, cls='';
            if(rd){
                const d=new Date(rd); d.setHours(0,0,0,0);
                diff=Math.ceil((d-today)/(86400000));
                if(diff<0) cls='overdue'; else if(diff<=7) cls='due-next-week'; else if(diff<=28) cls='due-soon';
            }
            return { ageDays: age, reviewDaysDiff: diff, reviewClass: cls };
        }
        function getRiskRating(s) { if(s<=5)return 'Low'; if(s<=10)return 'Medium'; if(s<=15)return 'High'; return 'Critical'; }
        function safeParseInt(v) { const n=parseInt(v,10); return isNaN(n)?'':n; }
        function calculateRiskScore(p, i) { p=parseInt(p); i=parseInt(i); return (p&&i&&!isNaN(p)&&!isNaN(i)) ? p*i : ''; }

        // === MODULE 4: Core Logic ===
        function updateLastFileDisplay() {
            const lastFile = localStorage.getItem('lastImportedFile') || 'None';
            lastFileDisplay.innerHTML = `Last Imported Source: <strong>${lastFile}</strong>`;
        }

        async function loadRisks(btn) {
            if(btn) btn.classList.add('loading');
            riskTableBody.innerHTML = '<tr><td colspan="30" style="text-align:center; padding:20px;">Loading...</td></tr>';
            try {
                await initDB();
                risks = await getAllRisksDB();
                
                // Migration/Cleanup
                risks.forEach(r => {
                    if(r.actions) { r.actionsText=r.actions; r.notesHistory=''; delete r.actions; }
                    if(r.actionsText===undefined) r.actionsText='';
                    if(r.relatedRisks===undefined) r.relatedRisks=''; // Ensure field exists
                });
                
                updateRiskOwnersList();
                populateOwnerFilter();
                applyDefaultReviewDateFilter();
                updateLastFileDisplay();
            } catch(e) {
                console.error(e); alert('Load failed.');
            } finally {
                if(btn) btn.classList.remove('loading');
            }
        }

        function applyDefaultReviewDateFilter() {
            const val = localStorage.getItem('reviewDateFilter') || '';
            if(!['Overdue','DueNextWeek','DueSoon'].includes(val)) {
                reviewDateFilter.value='Overdue'; localStorage.setItem('reviewDateFilter','Overdue');
            } else {
                reviewDateFilter.value = val;
            }
            renderRisks();
        }

        function updateRiskOwnersList() {
             riskOwners = [...new Set(risks.map(r => r.riskOwner).filter(o => o))].sort();
        }
        function populateOwnerFilter() {
            const curr = ownerFilter.value;
            ownerFilter.innerHTML = '<option value="">All Owners</option>';
            riskOwners.forEach(o => {
                const opt = document.createElement('option'); opt.value=o; opt.textContent=o;
                ownerFilter.appendChild(opt);
            });
            if(riskOwners.includes(curr)) ownerFilter.value = curr;
        }
        function filterTable() {
            localStorage.setItem('reviewDateFilter', reviewDateFilter.value);
            renderRisks();
        }

        function renderRisks() {
            riskTableBody.innerHTML = '';
            if (risks.length === 0) {
                 riskTableBody.innerHTML = '<tr><td colspan="30" style="text-align:center; padding: 20px;">No risks found.</td></tr>';
                 return;
            }

            const fStat = statusFilter.value;
            const fRate = ratingFilter.value;
            const fOwn = ownerFilter.value;
            const fRev = reviewDateFilter.value;

            const filtered = risks.filter(r => {
                const m = calculateDateMetrics(r.dateRaised, r.reviewDate);
                const sMatch = !fStat || r.riskStatus === fStat;
                const rMatch = !fRate || r.riskRatingResidual === fRate;
                const oMatch = !fOwn || (r.riskOwner||'') === fOwn;
                let dMatch = true;
                if(fRev==='Overdue') dMatch = m.reviewDaysDiff < 0;
                else if(fRev==='DueSoon') dMatch = m.reviewDaysDiff > 7 && m.reviewDaysDiff <= 28;
                else if(fRev==='DueNextWeek') dMatch = m.reviewDaysDiff >= 0 && m.reviewDaysDiff <= 7;
                return sMatch && rMatch && oMatch && dMatch;
            });

            filtered.forEach(r => {
                const rn = r.riskNumber;
                const tr = riskTableBody.insertRow();
                const m = calculateDateMetrics(r.dateRaised, r.reviewDate);
                
                const cell = (val, k) => {
                    const c = tr.insertCell();
                    c.setAttribute('data-risk-number', rn); c.setAttribute('data-key', k);
                    const d = document.createElement('div'); d.textContent = val;
                    if(k==='reviewDate') d.className = m.reviewClass;
                    c.appendChild(d);
                    return c;
                };

                tr.insertCell().innerHTML = `<div>${r.riskNumber}</div>`;
                tr.insertCell().innerHTML = `<div>${r.riskItem}</div>`;
                cell(r.riskOwner, 'riskOwner').ondblclick = handleInlineEdit;
                tr.insertCell().innerHTML = `<div><span class="${getRiskRatingClass(r.riskRatingResidual)}">${r.riskRatingResidual}</span></div>`;
                cell(r.riskStatus, 'riskStatus').ondblclick = handleInlineEdit;
                cell(r.reviewDate, 'reviewDate').ondblclick = handleInlineEdit;
                
                // ADDED: Linked Risks
                cell(r.relatedRisks, 'relatedRisks').ondblclick = handleInlineEdit;

                tr.insertCell().innerHTML = `<div>${m.ageDays}</div>`;
                tr.insertCell().innerHTML = `<div>${r.dateRaised}</div>`;
                tr.insertCell().innerHTML = `<div>${r.raisedBy}</div>`;
                tr.insertCell().innerHTML = `<div>${r.impactStatement}</div>`;
                tr.insertCell().innerHTML = `<div>${r.controlsMitigations}</div>`;
                tr.insertCell().innerHTML = `<div>${r.probabilityInitial}</div>`;
                tr.insertCell().innerHTML = `<div>${r.impactInitial}</div>`;
                tr.insertCell().innerHTML = `<div>${r.riskScoreInitial}</div>`;
                tr.insertCell().innerHTML = `<div><span class="${getRiskRatingClass(r.riskRatingInitial)}">${r.riskRatingInitial}</span></div>`;
                tr.insertCell().innerHTML = `<div>${r.probabilityResidual}</div>`;
                tr.insertCell().innerHTML = `<div>${r.impactResidual}</div>`;
                tr.insertCell().innerHTML = `<div>${r.riskScoreResidual}</div>`;
                
                cell(r.actionsText, 'actionsText').ondblclick = handleInlineEdit;
                tr.insertCell().innerHTML = `<div>${r.notesHistory}</div>`;

                tr.insertCell().innerHTML = `<div>${r.impactedArea}</div>`;
                tr.insertCell().innerHTML = `<div>${r.riskCategory}</div>`;
                tr.insertCell().innerHTML = `<div>${r.relatedLaws}</div>`;
                tr.insertCell().innerHTML = `<div>${r.nonComplianceImpact}</div>`;
                tr.insertCell().innerHTML = `<div>${r.outcomeDefinition}</div>`;
                tr.insertCell().innerHTML = `<div>${r.sourceDepartment}</div>`;
                tr.insertCell().innerHTML = `<div>${r.sourceLastReviewDate}</div>`;
                tr.insertCell().innerHTML = `<div>${r.sourceDueDate}</div>`;

                const act = tr.insertCell();
                const btn = document.createElement('button'); btn.textContent='Edit'; btn.className='edit-btn';
                btn.onclick = () => window.location.href = `risk_form.html?id=${rn}`;
                act.appendChild(btn);
            });
        }

        async function handleInlineEdit(e) {
            const cell = e.currentTarget;
            if(cell.querySelector('input, select')) return;
            const rn = cell.getAttribute('data-risk-number');
            const key = cell.getAttribute('data-key');
            const r = await getRiskByNumberDB(rn);
            if(!r) { await loadRisks(); return; }
            
            const val = r[key] || '';
            cell.querySelector('div').style.display='none';
            
            let input;
            if(key==='riskStatus') {
                input = document.createElement('select');
                RISK_STATUSES.forEach(s => {
                    const o = document.createElement('option'); o.value=s; o.textContent=s;
                    if(s===val) o.selected=true; input.appendChild(o);
                });
            } else if(key==='riskOwner') {
                input = document.createElement('select');
                const opts = [...riskOwners]; if(val && !opts.includes(val)) opts.push(val);
                input.innerHTML='<option value="">-- Select --</option>';
                opts.forEach(o => {
                    const op = document.createElement('option'); op.value=o; op.textContent=o;
                    if(o===val) op.selected=true; input.appendChild(op);
                });
            } else if(key==='reviewDate') {
                input = document.createElement('input'); input.type='date'; input.value=val;
            } else {
                // General Text Input (Actions, Related Risks)
                input = document.createElement('input'); input.type='text'; input.value=val;
            }
            
            input.className='inline-edit'; input.focus(); cell.appendChild(input);

            const save = async (nVal) => {
                if(!cell.contains(input)) return;
                if(String(nVal) !== String(val)) {
                    r[key] = (key.includes('Date')) ? getFormattedDate(nVal) : nVal;
                    await updateRiskInDB(r);
                    await loadRisks();
                } else {
                    cell.querySelector('div').style.display='';
                }
                if(cell.contains(input)) cell.removeChild(input);
            };

            input.addEventListener('change', e=>save(e.target.value));
            input.addEventListener('blur', e=>setTimeout(()=>save(e.target.value),50));
            input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); save(e.target.value); }});
        }

        // === MODULE 6: Import/Export ===
        function downloadFile(content, filename, mime) {
            const b = new Blob([content],{type:mime});
            const a = document.createElement('a');
            a.href=URL.createObjectURL(b); a.download=filename; a.style.display='none';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function getNextRiskNumber(arr) {
            if(!arr.length) return 1;
            return arr.reduce((m, r) => Math.max(m, parseInt(r.riskNumber)||0), 0) + 1;
        }

        async function ensureUniqueRiskNumbers(newRisks) {
            const existing = await getAllRisksDB();
            const seen = new Set(existing.map(r=>String(r.riskNumber)));
            let next = getNextRiskNumber(existing);
            
            for(const r of newRisks) {
                let rn = String(r.riskNumber).trim();
                if(!rn || isNaN(parseInt(rn)) || seen.has(rn)) {
                    rn = String(next);
                }
                if(parseInt(rn) >= next) next = parseInt(rn)+1;
                r.riskNumber = rn;
                seen.add(rn);
                
                // Standardize
                r.dateRaised = getFormattedDate(r.dateRaised);
                r.reviewDate = getFormattedDate(r.reviewDate);
                r.sourceLastReviewDate = getFormattedDate(r.sourceLastReviewDate);
                r.sourceDueDate = getFormattedDate(r.sourceDueDate);
                if(r.relatedRisks === undefined) r.relatedRisks = '';
            }
            return newRisks;
        }

        async function loadJson(txt) {
            const data = JSON.parse(txt);
            if(!Array.isArray(data)) throw new Error('Invalid JSON');
            const valid = await ensureUniqueRiskNumbers(data);
            await bulkPutRisksDB(valid);
            await loadRisks();
            alert(`Loaded ${valid.length} risks.`);
        }

        function convertToCsv(arr) {
            const h = csvHeaders.map(s=>`"${s.replace(/"/g,'""')}"`).join(',');
            const r = arr.map(row => {
                return csvHeaders.map(head => {
                    const k = csvHeaderToRiskKeyMap[head];
                    let v = row[k];
                    if(head==="Age (Days)") v = calculateDateMetrics(row.dateRaised).ageDays;
                    if(v==null) v='';
                    return `"${String(v).replace(/"/g,'""')}"`;
                }).join(',');
            });
            return [h, ...r].join('\n');
        }

        function parseCsv(txt) {
            const lines = txt.split(/\r?\n/).filter(l=>l.trim()!=='');
            if(lines.length<2) return [];
            
            // Parse Header
            const parseL = (l) => {
                const res=[]; let inQ=false, cur='';
                for(let c of l) {
                    if(c==='"') inQ=!inQ;
                    else if(c===',' && !inQ) { res.push(cur); cur=''; }
                    else cur+=c;
                }
                res.push(cur); return res.map(s=>s.trim().replace(/^"|"$/g,'').replace(/""/g,'"'));
            };
            
            const headers = parseL(lines[0]);
            const res = [];
            
            for(let i=1; i<lines.length; i++) {
                const vals = parseL(lines[i]);
                if(vals.length !== headers.length) continue;
                
                const d = {};
                headers.forEach((h, idx) => d[h] = vals[idx]);
                
                const pi = safeParseInt(d['Probability (Initial)'] || d['Likelihood']);
                const ii = safeParseInt(d['Impact (Initial)'] || d['Impact']);
                const pr = safeParseInt(d['Probability (Residual)'] || d['Likelihood Total']);
                const ir = safeParseInt(d['Impact (Residual)'] || d['Impact Total']);

                res.push({
                    riskNumber: d['Risk Number'] || d['Risk Ref.'] || '',
                    dateRaised: getFormattedDate(d['Date Raised']),
                    raisedBy: d['Raised By'] || d['Assigned To'] || '',
                    riskItem: d['Risk Item'] || d['Risk'] || '',
                    impactStatement: d['Impact Statement'] || d['Description of Impact'] || '',
                    riskOwner: d['Risk Owner'] || d['Reviewed By'] || '',
                    reviewDate: getFormattedDate(d['Review Date'] || d['Next Review Date']),
                    
                    actionsText: d['Actions Text (Current)'] || d['Actions'] || d['Notes & Comments'] || '',
                    notesHistory: d['Notes / History'] || '',
                    relatedRisks: d['Related Risks'] || '', // ADDED MAP
                    
                    riskStatus: d['Risk Status'] || (d['Closed Date']?'Closed':'Open'),
                    
                    probabilityInitial: pi, impactInitial: ii, 
                    riskScoreInitial: calculateRiskScore(pi,ii), riskRatingInitial: getRiskRating(pi*ii),
                    
                    probabilityResidual: pr, impactResidual: ir, 
                    riskScoreResidual: calculateRiskScore(pr,ir), riskRatingResidual: getRiskRating(pr*ir),
                    
                    controlsMitigations: d['Controls/Mitigations'] || '',
                    sourceDepartment: d['Source Department'] || '',
                    sourceLastReviewDate: getFormattedDate(d['Source Last Review Date']),
                    sourceDueDate: getFormattedDate(d['Source Due Date']),
                    
                    riskIssue: d['Risk Issue'] || '', impactedArea: d['Impacted Area'] || '',
                    riskCategory: d['Risk Category'] || '', relatedLaws: d['Related Laws/Regulations'] || '',
                    nonComplianceImpact: d['Non-Compliance Impact'] || '', outcomeDefinition: d['Outcome Definition'] || ''
                });
            }
            return res;
        }

        async function handleCsvLoad(txt) {
            const data = parseCsv(txt);
            const valid = await ensureUniqueRiskNumbers(data);
            await bulkPutRisksDB(valid);
            await loadRisks();
            alert(`Loaded ${valid.length} risks from CSV.`);
        }

        // === EVENTS ===
        loadDataButton.onclick = () => {
            if(!fileInput.files.length) return alert('Select file');
            const f = fileInput.files[0];
            const fname = f.name.toLowerCase();
            (async () => {
                loadDataButton.classList.add('loading');
                try {
                    if((await getAllRisksDB()).length > 0 && !confirm('Replace data?')) return;
                    const txt = await f.text();
                    if(fname.endsWith('.json')) await loadJson(txt);
                    else if(fname.endsWith('.csv')) await handleCsvLoad(txt);
                    else alert('Invalid type');
                    localStorage.setItem('lastImportedFile', f.name);
                    updateLastFileDisplay();
                } catch(e) { console.error(e); alert('Error loading'); }
                finally { loadDataButton.classList.remove('loading'); }
            })();
        };

        loadDefaultFileButton.onclick = async () => {
            loadDefaultFileButton.classList.add('loading');
            try {
                if((await getAllRisksDB()).length > 0 && !confirm('Replace data?')) return;
                const res = await fetch(DEFAULT_RISK_FILE_PATH);
                if(!res.ok) throw new Error(res.statusText);
                await loadJson(await res.text());
                localStorage.setItem('lastImportedFile', 'Default System Data');
                updateLastFileDisplay();
            } catch(e) { console.error(e); alert('Default load failed: '+e.message); }
            finally { loadDefaultFileButton.classList.remove('loading'); }
        };

        saveJsonButton.onclick = () => {
            if(!risks.length) return alert('Empty');
            downloadFile(JSON.stringify(risks,null,2), `risk_register_${getFormattedDate(new Date())}.json`, 'application/json');
        };
        saveCsvButton.onclick = () => {
            if(!risks.length) return alert('Empty');
            downloadFile(convertToCsv(risks), `risk_register_${getFormattedDate(new Date())}.csv`, 'text/csv');
        };

        addNewRiskButton.onclick = () => window.location.href='risk_form.html';
        manageDataButton.onclick = () => window.location.href='data_management.html';

        document.addEventListener('DOMContentLoaded', () => {
            if(!localStorage.getItem('reviewDateFilter')) localStorage.setItem('reviewDateFilter','Overdue');
            loadRisks();
        });
    </script>
</body>
</html>
